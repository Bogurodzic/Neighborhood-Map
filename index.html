<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" type="text/css" href="css/reset.css">
  <link rel="stylesheet" type="text/css" href="css/styles.css">
  <link href="https://fonts.googleapis.com/css?family=Proza+Libre" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Gentium+Basic" rel="stylesheet">
  <script src="js/lib/jquery-3.1.1.min.js"></script>
  <script src="js/lib/knockout-3.4.0.js"></script>
  <title>Neighborhood Map</title>
</head>
<body>
  <aside>
    <div id="title">My Favourite Locations</div>
    <div id="filter-box">
      <div id="filter-text-area"><input id="filter-text" type="text" placeholder="Filter list here." data-bind="value: filter, valueUpdate: 'afterkeydown'"></div>
      <div id="filter-area"><input id="filter" type="button" value="Filter" data-bind="click: hideListings"></div>
    </div>
    <div id="list-view">
      <ul data-bind="foreach: filteredItems">
        <li data-bind="text: title"></li>
      </ul>
    </div>

  </aside>
  <div id="map"></div>
  <script>
    var map;
    //array for the markers
    var markers = [];

    var locations = [
	    {title: 'Złote Tarasy', location: {lat: 52.230005, lng: 21.0003818}},
	    {title: 'University of Warsaw', location: {lat: 52.2403463, lng: 21.0164125}},
	    {title: 'Empik', location: {lat: 52.2333044, lng: 21.0080667}},
        {title: 'Google', location: {lat: 52.2335813, lng: 20.9996984}},
        {title: 'Warsaw Old Town', location: {lat: 52.2500272, lng: 21.0092833}},
        {title: 'National Stadium Warsaw', location: {lat: 52.2394957, lng: 21.0436022}},
        {title: 'Warsaw University of Technology', location: {lat: 52.2212012, lng: 21.005897}},
        {title: 'Warsaw Uprising Museum', location: {lat: 52.232324, lng: 20.9789653}},
        {title: 'Presidential Palace', location: {lat: 52.243168, lng: 21.0144238}},
        {title: 'Fryderyk Chopin Museum', location: {lat: 52.2365397, lng: 21.0207457}},
        {title: 'Grand Theatre Warsaw', location: {lat: 52.2390616, lng: 21.0036875}}
	];

    function initMap() {

    	//styling map a bit (:
        var styles = [{"stylers":[{"hue":"#dd0d0d"}]},{"featureType":"road","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"geometry","stylers":[{"lightness":100},{"visibility":"simplified"}]}];

        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 52.231838, lng: 21.0038063},
          zoom: 13,
          styles: styles
        });

        var infoWindow = new google.maps.InfoWindow();

        //Create a default icon
        var defaultIcon = makeMarkerIcon("6E5A79");

        //Create a highlited icon
        var highlitedIcon = makeMarkerIcon("8D363B");

        //Place markers on the map
        for (var i=0; i<locations.length; i++){
          var title = locations[i].title;
          var location = locations[i].location;
          var marker = new google.maps.Marker({
            position: location,
            map: map,
            title: title,
            icon: defaultIcon,
            animation: google.maps.Animation.DROP,
            id: i
          });

          marker.addListener("mouseover", function(){
          	this.setIcon(highlitedIcon);
          });

          marker.addListener("mouseout", function(){
          	this.setIcon(defaultIcon);
          });

          marker.addListener("click", function(){
          	makeInfoWindow(this, infoWindow);
          });

          marker.addListener("click", toggleBounce);

          markers.push(marker);
        }



        function makeInfoWindow(marker, window){
        	// Check to make sure the infowindow is not already opened on this marker.


        	if(window.marker != marker){
        		window.marker = marker;

        	var description = ""; 

	    	$.ajax({
	        	url: "https://en.wikipedia.org/w/api.php?action=opensearch&format=json&search="+marker.title+"",
	        	type: "GET",
	        	dataType: "jsonp",
	        	success: function (data) {
	        	console.log(data);
	        	description = "<div id='iw-container'>" +"<div class='iw-title'><strong>"+ data[1][0] +"</strong></div>" + "<p>" + data[2][0] +"<p>" + "</div><div class='iw-bottom-gradient'></div>";
	        	window.setContent(description);
        		window.open(map, marker);
	  		}, 
	      	xhrFields: {
	        	withCredentials: false
	      		} 
	        });        		
        		        		
        		// Make sure the marker property is cleared if the infowindow is closed.
        		window.addListener('closeclick', function(){
        			window.setMarker(null);
        		});

        	}
        }

 		//Active bounce animation
        function toggleBounce() {
 			if (this.getAnimation() !== null) {
    			this.setAnimation(null);
  			} else {
    			this.setAnimation(google.maps.Animation.BOUNCE);
  			}
		}

		//Makes custom marker style
        function makeMarkerIcon(markerColor){
    		var markerImage = new google.maps.MarkerImage('http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|'+ markerColor +
            '|40|_|%E2%80%A2',
          	new google.maps.Size(21, 34),
          	new google.maps.Point(0, 0),
          	new google.maps.Point(10, 34),
          	new google.maps.Size(21,34));
        	return markerImage;
   		}

    }

    //Locations Observable Constructor
    var obsLocation = function(location){
    	return {
    		title: ko.observable(location.title),
    		cords: ko.observable(location.location)
    	}
    }

    var ViewModel = function(){

    	var self = this;

    	//Locations observable array
        this.places = ko.observableArray([
	    new obsLocation({
	        title: 'Złote Tarasy',
	        location: {lat: 52.230005, lng: 21.0003818}
	    }),
	    new obsLocation({
	        title: 'University of Warsaw', 
	        location: {lat: 52.2403463, lng: 21.0164125}
	    }),
	    new obsLocation({
			title: 'Empik', 
			location: {lat: 52.2333044, lng: 21.0080667}
	    }),
	     new obsLocation({
			title: 'Google', 
			location: {lat: 52.2335813, lng: 20.9996984}
	    }),
	    new obsLocation({
        	title: 'Warsaw Old Town', 
        	location: {lat: 52.2500272, lng: 21.0092833},
	    }),
	    new obsLocation({
			title: 'National Stadium Warsaw',
			location: {lat: 52.2394957, lng: 21.0436022}
	    }),
	   	new obsLocation({
	   		title: 'Warsaw University of Technology', 
	   		location: {lat: 52.2212012, lng: 21.005897}
	    }),
	   	new obsLocation({
	   		title: 'Warsaw Uprising Museum', 
	   		location: {lat: 52.232324, lng: 20.9789653}
	    }),
	   	new obsLocation({
	   		title: 'Presidential Palace', 
	   		location: {lat: 52.243168, lng: 21.0144238}
	    }),
	   	new obsLocation({
	   		title: 'Fryderyk Chopin Museum', 
	   		location: {lat: 52.2365397, lng: 21.0207457}
	    }),
	    new obsLocation({
	    	title: 'Grand Theatre Warsaw', 
	    	location: {lat: 52.2390616, lng: 21.0036875}
	    })
    ])
        //holds #filter-text value
        this.filter = ko.observable("");

        //Filter places due to filter value
        this.filteredItems = ko.computed(function(){
        	//compare filter to places array
        	var stringStartsWith = function (string, startsWith) {          
   				string = string || "";
    			if (startsWith.length > string.length)
        			return false;
    			return string.substring(0, startsWith.length) === startsWith;
			};
			//placeholder for filter observable
        	var filter = self.filter().toLowerCase();
        	//return places if filter is empty
        	if (!filter){
        		return self.places();
        	} else {
        		//filter array
        		return ko.utils.arrayFilter(self.places(), function(place){
        			//compare filter to place.title and return if they match
            		return stringStartsWith(place.title().toLowerCase(), filter);
        		});
        	}
        }, self);


        //Hide all markers
        this.hideListings = function(){
        	for (var i=0; i<markers.length; i++){
        		markers[i].setMap(null);
        	}
        }

        //Show chosen marker when you click ,,filter" button.
        this.showOne = function(){
        	for (var j=0; j<markers.length; j++){
        		value = document.getElementById("filter-text").value;
        		if (value === locations[j].title){
        			markers[j].setMap(map);
        		}
        	}
        }


        //Show filtered markers from filteredItems computed observable
        this.displayMarkers = function(){
        	if (self.filter() != "")
        	self.hideListings();
        	for (var i=0; i<markers.length; i++){
        		for (var j=0; j<self.filteredItems().length; j++){
        			if (markers[i].title == self.filteredItems()[j].title()){
        				markers[i].setMap(map);
        			}
        		}
        	}
        }

        document.getElementById("filter-text").addEventListener("keyup", function(){
        	self.displayMarkers();
        });
    };

    ko.applyBindings(new ViewModel());



    </script>
    <script src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyBwTkrCtLKEQD5ocyIcgNZgCwQFjwtMRs0&callback=initMap"
    async defer></script>
</body>
</html>